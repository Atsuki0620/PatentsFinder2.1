# PatentsFinder2.1 Upgrade Guide

---

## 改良方針・設計要件

### 1. AI抽出条件の表示
- LLMが自動抽出したIPCコード・キーワードを画面に表示。
- ユーザーが編集可能。

### 2. LLMと対話形式で検索条件を作成。
- LLMと対話形式で、調査したい内容を絞り込む
- AIが候補を出し、ユーザーは自然言語で必要に応じて回答。対話を繰り返して調査の要件を作っていく。

### 3. 検索件数上限の指定
- 検索件数上限（LIMIT）をユーザーが入力可能。

### 4. 検索クエリ・SQLの可視化と説明
- 検索条件オブジェクト・生成SQL文を画面に表示。
- それぞれAIによる自然言語説明を付与。

### 5. 検索結果の取得件数表示
- 実際の取得件数を明示。

### 6. 類似度分析の仕組み表示
- 技術内容と特許文献（タイトル＋要約＋請求項）をEmbeddingでベクトル化し、コサイン類似度で比較。
- 分析対象・手順を画面に説明。

### 7. Embeddingモデルの利用箇所明示
- 類似度分析時にEmbeddingモデルを利用。

### 8. 表示言語の選択
- 検索結果表は日本語フィールドを優先。
- 表示言語切替UIを追加。

### 9. 要約対象の選択・複数要約
- ユーザーが任意のレコードを選択し、個別・複数要約が可能。

### 10. 履歴の保持
- 検索した際のキーワード・IPC・期間、検索結果のデータフレーム、ベクトル化した際のベクトルデータベースを保持する機能を新設計する。

### 11. 機能の可視化
- エージェントの動作状況をユーザーに知らせる。
- エージェント間のグラフ関係をマーメイド表示し、処理中にどのノードで作動しているのか動的に更新させ表示させる。

---

## 開発方針

### 1. 全体方針
- **責務の分離:** UI関連の改修は `src/app.py`、対話やワークフロー制御は `src/core/agent.py`、状態管理は `src/core/state.py` に責務を明確に分離して実装を進める。
- **既存機能の尊重:** BigQueryへの検索ロジック (`src/core/tools.py`) は原則として変更せず、インタフェースとして利用する。SQLの直接編集は避ける。
- **段階的実装:** まずはコア機能である「対話による検索条件生成」と「UIへの反映」を実装し、その後、履歴機能や可視化機能を追加していく。

### 2. UI/UX (担当: `src/app.py`)
- Streamlitのセッション状態 (`st.session_state`) を活用し、対話履歴や検索条件、結果をページリロード後も保持する。
- 検索条件（IPC、キーワード、期間）の入力欄は `st.text_area` や `st.text_input` を使用し、LLMからの提案を初期値として表示し、ユーザーが編集可能にする。
- 検索件数上限（LIMIT）は `st.number_input` で実装する。
- 検索クエリやSQL、AIによる説明は `st.expander` を利用して表示し、UIの煩雑化を防ぐ。
- エージェントの動作状況（マーメイド図）は `st.graphviz_chart` または `st.markdown` を利用して表示。`src/core/agent.py` から渡された描画定義を動的に更新する。
- 検索結果は `st.dataframe` で表示し、`st.data_editor` のチェックボックス機能を利用して、ユーザーが要約対象を選択できるようにする。

### 3. エージェント・バックエンド (担当: `src/core/agent.py`)
- `langgraph` を用いて、[ユーザー入力] -> [LLMによる条件抽出] -> [ユーザー確認・編集] -> [SQL生成] -> [検索実行] -> [結果表示/要約] の一連のワークフローをグラフとして定義する。
- ユーザーとの対話のために、専用のプロンプトテンプレートを設計・実装する。
- ワークフローの各ステップ（ノード）が実行されるたびに、現在の状態を `src/core/state.py` の状態管理クラスに通知し、UIの動的更新をトリガーする。
- SQLや検索条件の説明、類似度分析の仕組みに関する説明文は、LLMを呼び出して動的に生成する。

### 4. 状態・履歴管理 (担当: `src/core/state.py`)
- アプリケーションの状態（検索条件、対話履歴、検索結果DF、生成SQLなど）を保持するPydanticモデルまたはデータクラスを定義する。
- Streamlitの `st.session_state` にこの状態オブジェクトを格納し、アプリケーション全体で一貫した状態管理を実現する。
- 検索履歴機能として、状態オブジェクトをシリアライズ（例: JSON形式）し、ローカルファイルやデータベースに保存・読込する機能を実装する。

---

## 実装上の注意
- UI・説明は簡潔に。
- すべての新機能は既存の検索・分析フローに統合。
- セキュリティ・開発規約は従来通り厳守。
